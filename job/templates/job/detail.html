{% extends 'base.html' %}

{% load staticfiles %}
{% block import %}
    <link rel="stylesheet" type="text/css" href="{% static 'job/CSS/detail.css' %}" />
    <script type="text/javascript" src="{% static 'job/JavaScript/detail.js' %}" ></script>
    <script src="https://checkout.stripe.com/checkout.js"></script>
{% endblock %}

{% block content %}
<div class=" row">
    <div class="col-md-12">
        {{ job.name }}
    </div>
</div>
<div class="row">
    <div class="col-md-12">
    {% for tag in job.tag_set.all %}
        #{{ tag.tag }}
    {% empty %}
        There are no tags
    {% endfor %}
    </div>
</div>
<div class="row">
    <div class="col-md-12">
    {% if job.image_set.all.count > 0 %}
        <div id="images">
        {% for image in job.image_set.all %}
            <img src="{{ image.image.url }}" class="img-responsive image">
        {% endfor %}
        </div>
    {% endif %}
    </div>
</div>
<div class="row">
    <div id="job_description" class="col-md-12">
        {{ job.description }}
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <h4>Pledges</h4>
    </div>
</div>
<div class="row">
    <div class="information_table col-md-12">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Pledged</th>
                    <th>Date Pledged</th>
                    <th>Paid</th>
                </tr>
            </thead>
            <tbody>
            {% for pledge in pledges %}
                <tr>
                    <td>{{ pledge.jobuser.user.first_name }}&nbsp;{{ pledge.jobuser.user.last_name }}</td>
                    <td>{{ pledge.amount }}</td>
                    <td>{{ pledge.date }}</td>
                    <td>{{ pledge.jobuser.amount_paid }}</td>
                </tr>
            {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td>Total Pledged</td>
                    <td>{{ total_pledged }}</td>
                    <td>Total Paid:</td>
                    <td>{{ total_paid }}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <h4>Workers</h4>
    </div>
</div>
<div class="row">
    <div class="information_table col-md-12">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Started</th>
                    <th>Finished</tH>
                    <th>Paid</th>
                    <th>Pay This User</th>
                </tr>
            </thead>
            <tbody>
                <form id="pay_form" action="{{ request.get_full_path }}" method="POST" >
                {% csrf_token %}
                {% for worker in workers %}
                    <tr>
                        <td>
                            {% if worker.jobuser.user.is_active %}
                            <a href="{% url 'user:detail' worker.jobuser.user.username %}">
                                {{ worker.jobuser.user.first_name }}&nbsp;{{ worker.jobuser.user.last_name }}
                            </a>
                            {% else %}
                            <span>[ Deleted User ]</span>
                            {% endif %}
                        </td>
                        <td>{{ worker.date }}</td>
                        <td>{{ worker.jobuser.finish_set.all.exists }}</td>
                        <td>{{ pledger.paid }}</td>
                        <td>
                            {% if jobuser.pledge_set.all and request.user.username != worker.jobuser.user.username %}
                            <input id="{{ worker.jobuser.user.username }}-amount_paying" type="text" placeholder="Amount" />
                            <input id="{{ worker.jobuser.user.username }}-pay_button" class="pay_button" type="button" value="Pay" />
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                    <input id="pay_to" type="hidden" name="pay_to" />
                    <input id="pay_amount" type="hidden" name="pay_amount" /> 
                    <input id="stripe_token" type="hidden" name="stripeToken" />
                </form>
            </tbody>
            <tfoot>
                <tr>
                    <td>Total Workers</td>
                    <td>{{ workers.count }}</td>
                    <td>Still Working</td>
                    <td>{{ total_working }}</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <h4>Updates</h4>
    </div>
</div>
<div class="row">
    <div class="col-md-12 information_table">
        <table id="updates_table" class="table">
            <thead>
                <tr>
                    <th id="last_name" class="sort">User</th>
                    <th id="date" class="sort">Date</th>
                    <th id="title" class="sort">Title</th>
                    <th id="images" class="sort">Image/s</th>
                </tr>
            </thead>
            <tbody id="last_name_ascending">
            {% for update in updates_last_name %}
                <tr>
                    <td>
                        {% if update.jobuser.user.is_active %}
                        <a href="{% url 'user:detail' update.jobuser.user.username %}">
                            {{ update.jobuser.user.first_name }}&nbsp;{{ update.jobuser.user.last_name }}
                        </a>
                        {% else %}
                        <span>[ Deleted User ]</span>
                        {% endif %}
                    </td>
                    <td>{{ update.date }}</td>
                    <td>
                        <a href="{% url 'jobuser:view_update' update.id %}">{{ update.title }}</a>
                    </td>
                    <td>
                    {% if update.image_set.all %}
                        Yes
                    {% else %}
                        No
                    {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr><td>No Updates</td></tr>
            {% endfor %}
            </tbody>
            <tbody id="last_name_descending">
            {% for update in updates_last_name reversed %}
                <tr>
                    <td>
                        {% if update.jobuser.user.is_active %}
                        <a href="{% url 'user:detail' update.jobuser.user.username %}">
                            {{ update.user.first_name }}&nbsp;{{ update.jobuser.user.last_name }}
                        </a>
                        {% else %}
                        <span>[ Deleted User ]</span>
                        {% endif %}
                    </td>
                    <td>{{ update.date }}</td>
                    <td>
                        <a href="{% url 'jobuser:view_update' update.id %}">{{ update.title }}</a>
                    </td>
                    <td>
                    {% if update.image_set.all %}
                        Yes
                    {% else %}
                        No
                    {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr><td>No Updates</td></tr>
            {% endfor %}
            </tbody>
            <tbody id="date_ascending">
            {% for update in updates_date %}
                <tr>
                    <td>
                        {% if update.jobuser.user.is_active %}
                        <a href="{% url 'user:detail' update.jobuser.user.username %}">
                            {{ update.jobuser.user.first_name }}&nbsp;{{ update.jobuser.user.last_name }}
                        </a>
                        {% else %}
                        <span>[ Deleted User ]</span>
                        {% endif %}
                    </td>
                    <td>{{ update.date }}</td>
                    <td>
                        <a href="{% url 'jobuser:view_update' update.id %}">{{ update.title }}</a>
                    </td>
                    <td>
                    {% if update.image_set.all %}
                        Yes
                    {% else %}
                        No
                    {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr><td>No Updates</td></tr>
            {% endfor %}
            </tbody>
            <tbody id="date_descending" >
            {% for update in updates_date reversed %}
                <tr>
                    <td>
                        {% if update.jobuser.user.is_active %}
                        <a href="{% url 'user:detail' update.jobuser.user.username %}">
                            {{ update.jobuser.user.first_name }}&nbsp;{{ update.jobuser.user.last_name }}
                        </a>
                        {% else %}
                        <span>[ Deleted User ]</span>
                        {% endif %}
                    </td>
                    <td>{{ update.date }}</td>
                    <td>
                        <a href="{% url 'jobuser:view_update' update.id %}">{{ update.title }}</a>
                    </td>
                    <td>
                    {% if update.image_set.all %}
                        Yes
                    {% else %}
                        No
                    {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr><td>No Updates</td></tr>
            {% endfor %}
            </tbody>
            <tbody id="title_ascending">
            {% for update in updates_title %}
                <tr>
                    <td>
                        {% if update.jobuser.user.is_active %}
                        <a href="{% url 'user:detail' update.jobuser.user.username %}">
                            {{ update.jobuser.user.first_name }}&nbsp;{{ update.jobuser.user.last_name }}
                        </a>
                        {% else %}
                        <span>[ Deleted User ]</span>
                        {% endif %}
                    </td>
                    <td>{{ update.date }}</td>
                    <td>
                        <a href="{% url 'jobuser:view_update' update.id %}">{{ update.title }}</a>
                    </td>
                    <td>
                    {% if update.image_set.all %}
                        Yes
                    {% else %}
                        No
                    {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr><td>No Updates</td></tr>
            {% endfor %}
            </tbody>
            <tbody id="title_descending">
            {% for update in updates_title reversed %}
                <tr>
                    <td>
                        {% if update.jobuser.user.is_active %}
                        <a href="{% url 'user:detail' update.jobuser.user.username %}">
                            {{ update.jobuser.user.first_name }}&nbsp;{{ update.jobuser.user.last_name }}
                        </a>
                        {% else %}
                        <span>[ Deleted User ]</span>
                        {% endif %}
                    </td>
                    <td>{{ update.date }}</td>
                    <td>
                        <a href="{% url 'jobuser:view_update' update.id %}">{{ update.title }}</a>
                    </td>
                    <td>
                    {% if update.image_set.all %}
                        Yes
                    {% else %}
                        No
                    {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr><td>No Updates</td></tr>
            {% endfor %}
            </tbody>
            {% if ordered_updates %}
            <tfoot>
                <tr>
                    <td></td>
                    <td>Total:</td>
                    <td>{{ ordered_updates.count }}</td>
                </tr>
            </tfoot>
            {% endif %}
        </table>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        {% if jobuser %}
        <form action="{% url 'jobuser:post_update' jobuser.id %}">
            <input id="post_update" class="pledge_work_inputs" type="submit" value="Post Update" />
        </form>
        {% endif %}
    </div>
</div>
<div class="row">
    {% if not jobuser or not jobuser.pledge_set.all.exists %}
    <div class="col-md-6">
        <form action="{{ request.get_full_path }}" method="POST">
            {% csrf_token %}
            <input id="pledge_money" class="pledge_work_inputs" type="button" value="Pledge"  />
            <input class="starts_hidden pledge_clicked" type="text" placeholder="Amount" name="pledge_money_to_job" />
            <input class="starts_hidden pledge_clicked" type="submit" value="Accept"  />
        </form>
    </div>
    {% endif %}
    {% if jobuser and jobuser.work_set.all.exists %}
    <div class="col-md-6">
        <form action="{{ request.get_full_path }}" method="POST">
            {% csrf_token %}
            <input id="finish_job" class="pledge_work_inputs" type="submit" value="Finish" name="finish_job" />
        </form>
    </div>
    {% elif not jobuser and not jobuser.work_set.all.exists %}
    <div class="col-md-6">
        <form action="{{ request.get_full_path }}" method="POST">
            {% csrf_token %}
            {% if user_has_stripe_account %}
            User has stripe_account
            <input id="work_on_job" class="pledge_work_inputs" type="submit" value="Work" name="work_on_job" />
            {% else %}
            <input id="work_on_job" class="pledge_work_inputs" type="button" value="Work" name="work_on_job" />
            <span id="connect_with_stripe_message">We do not have your Stripe account on record. Please click here to sign-in or create account with Stripe so that you can be properly paid.</span>
            <a href="https://connect.stripe.com/oauth/authorize?response_type=code&client_id=ca_B36oLqq9HCaIyv4FlXeUgqdKvEwQGSxV&scope=read_write" id="stripe_connect" class="stripe-connect">
                <span>Connect with Stripe</span>
            </a>
            {% endif %}
        </form>
    </div>
    {% endif %}
</div>
{% endblock %}